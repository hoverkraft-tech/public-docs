---
sidebar_position: 9
---

# Workflow Reference

Use this page as a quick reference while wiring Hoverkraft reusable workflows. The defaults target a single deployable app under `application/` with a multi-stage Dockerfile at `docker/application/Dockerfile`. When you run multiple services (microservices, monorepos, workers), expand the same patterns by adding entries per service.

> **Reminder**: The `.devcontainer` image is tooling only (editor extensions, Docker CLI). Run build, lint, and deploy commands inside the application containers defined in `docker/application/Dockerfile` (and any additional `docker/<service>/Dockerfile` you add) so CI and local environments stay aligned.

## Reusable Workflow Catalog

### `hoverkraft-tech/ci-github-common`

| Workflow                    | Purpose                                              |
| --------------------------- | ---------------------------------------------------- |
| `linter.yml`                | Configurable super-linter with SARIF support         |
| `semantic-pull-request.yml` | Enforces Conventional Commit pull request titles     |
| `greetings.yml`             | Welcomes first-time contributors                     |
| `stale.yml`                 | Marks inactive issues and pull requests              |
| `need-fix-to-issue.yml`     | Logs ‚Äúchanges requested‚Äù reviews as follow-up issues |

Pin each workflow to a tested commit SHA (e.g., `@1c379f7f6e0fc850fe5a7111f74d54e159b4dcd2 # 0.26.0`) and monitor [releases](https://github.com/hoverkraft-tech/ci-github-common/releases) for updates.

### `hoverkraft-tech/ci-github-container`

| Workflow / Action                                       | Purpose                                                                |
| ------------------------------------------------------- | ---------------------------------------------------------------------- |
| `.github/workflows/docker-build-images.yml`             | Builds multi-stage images and exposes metadata (`built-images` output) |
| `.github/workflows/prune-pull-requests-images-tags.yml` | Cleans stale images/tags generated by PR builds                        |
| `actions/helm/test-chart`                               | Runs `ct lint` and `helm kubeconform` using built image metadata       |
| `actions/helm/generate-docs`                            | Regenerates Helm chart documentation (`helm-docs`)                     |

Provide an OCI registry (`GHCR`, `ECR`, etc.) via `vars.OCI_REGISTRY` and pin the workflow to a validated commit (e.g., `@4f29319e02dd65152386c436e8c3136f380a0e71 # 0.28.0`).

### `hoverkraft-tech/ci-github-publish`

| Workflow / Action                       | Purpose                                        |
| --------------------------------------- | ---------------------------------------------- |
| `.github/workflows/deploy-chart.yml`    | Deploy Helm charts through GitHub App + GitOps |
| `.github/workflows/clean-deploy.yml`    | Tear down review environments                  |
| `.github/workflows/prepare-release.yml` | Draft release notes, collect change summaries  |
| `actions/release/create`                | Create GitHub Releases with semantic tagging   |

Requires GitHub App credentials (`CI_BOT_APP_ID`, `CI_BOT_APP_PRIVATE_KEY`). Pin to the release commit you validated (e.g., `@42d50a3461a177557ca3f83b1d927d7c0783c894 # 0.11.2`).

### Optional: Language-Specific Workflows

If a service cannot run inside a container (legacy runtimes, SaaS builds), reuse the language-specific workflows (`ci-github-nodejs`, etc.). Prefer the container-first approach when possible to keep the stack agnostic.

## Blueprint Snippets

### Shared CI (`__shared-ci.yml`)

```yaml title=".github/workflows/__shared-ci.yml"
name: Shared ‚Äì Continuous Integration

on:
  workflow_call:

jobs:
  linter:
    uses: hoverkraft-tech/ci-github-common/.github/workflows/linter.yml@<commit-sha-common>

  build:
    uses: hoverkraft-tech/ci-github-container/.github/workflows/docker-build-images.yml@<commit-sha-container>
    with:
      oci-registry: ${{ vars.OCI_REGISTRY }}
      images: |
        [
          {
            "name": "ci",
            "context": ".",
            "dockerfile": "./docker/application/Dockerfile",
            "build-args": { "APP_PATH": "./application/" },
            "target": "ci",
            "platforms": ["linux/amd64"]
          },
          {
            "name": "application",
            "context": ".",
            "dockerfile": "./docker/application/Dockerfile",
            "build-args": { "APP_PATH": "./application/" },
            "target": "prod",
            "platforms": ["linux/amd64"]
          }
        ]

  sast:
    needs: build
    container:
      image: ${{ fromJSON(needs.build.outputs.built-images).ci.images[0] }}
    steps:
      - run: ./scripts/run-static-analysis.sh

  report-sast:
    if: github.event_name == 'pull_request'
    needs: sast
    steps:
      - uses: actions/download-artifact@<commit-sha-download>
        with:
          name: lint-report
      - uses: ataylorme/eslint-annotate-action@<commit-sha-annotate>
        with:
          report-json: lint-report.json

  tests-charts:
    needs: build
    steps:
      - uses: hoverkraft-tech/ci-github-container/actions/helm/test-chart@<commit-sha-container>
        with:
          helm-set: |
            image.registry=${{ fromJSON(needs.build.outputs.built-images).application.registry }}
            image.repository=${{ fromJSON(needs.build.outputs.built-images).application.repository }}
            image.tag=${{ fromJSON(needs.build.outputs.built-images).application.tags[0] }}
            image.digest=${{ fromJSON(needs.build.outputs.built-images).application.digest }}
          oci-registry: ${{ vars.OCI_REGISTRY }}
          oci-registry-password: ${{ github.token }}
```

Extend the `images` array and downstream references (`service-b`, `worker`, etc.) whenever you build more than one artifact.

### Wrapper Workflows

```yaml title=".github/workflows/pull-request-ci.yml"
name: Pull request ‚Äì Continuous Integration

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    uses: ./.github/workflows/__shared-ci.yml
    secrets: inherit
```

```yaml title=".github/workflows/main-ci.yml"
name: Main ‚Äì Continuous Integration

on:
  push:
    branches: [main]

jobs:
  clean:
    uses: hoverkraft-tech/ci-github-container/.github/workflows/prune-pull-requests-images-tags.yml@<commit-sha-container>
    with:
      images: '["ci","application"]'

  ci:
    uses: ./.github/workflows/__shared-ci.yml
    secrets: inherit

  helm-docs:
    needs: ci
    steps:
      - uses: actions/checkout@<commit-sha-checkout>
      - uses: hoverkraft-tech/ci-github-container/actions/helm/generate-docs@<commit-sha-container>
        with:
          working-directory: ./charts
          github-app-id: ${{ vars.CI_BOT_APP_ID }}
          github-app-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
```

### Deployment Entry Points

```yaml title=".github/workflows/deploy.yml"
name: Deploy chart

on:
  issue_comment:
    types: [created]
  workflow_call:
    inputs:
      tag:
        description: "Image tag to deploy"
        required: true
        type: string
      environment:
        description: "review | uat | production"
        required: true
        type: string

permissions:
  contents: write
  issues: write
  packages: write
  pull-requests: write
  deployments: write
  actions: read
  id-token: write

jobs:
  deploy:
    uses: hoverkraft-tech/ci-github-publish/.github/workflows/deploy-chart.yml@<commit-sha-publish>
    secrets:
      oci-registry-password: ${{ secrets.GITHUB_TOKEN }}
      github-app-key: ${{ secrets.CI_BOT_APP_PRIVATE_KEY }}
    with:
      url: ${{ (inputs.environment == 'uat' && vars.UAT_URL) || (inputs.environment == 'production' && vars.PRODUCTION_URL) || vars.REVIEW_APPS_URL }}
      tag: ${{ inputs.tag }}
      environment: ${{ inputs.environment }}
      github-app-id: ${{ vars.CI_BOT_APP_ID }}
      deploy-parameters: |
        { "repository": "${{ github.repository_owner }}/argocd-app-of-apps" }
      images: |
        [
          { "name": "application", "context": ".", "dockerfile": "./docker/application/Dockerfile", "target": "prod" }
        ]
      chart-values: |
        [
          { "path": "application.image", "image": "application" },
          { "path": "application.version", "value": "{{ tag }}" },
          { "path": "deploy.ingress.hosts[0].host", "value": "{{ url }}" }
        ]
```

Duplicate the `images` and `chart-values` entries per service (`service-b`, worker queues, etc.). Add `clean-deploy.yml`, `prepare-release.yml`, and `release.yml` pinned to the same commit.

## Secrets and Variables Cheat Sheet

| Name                         | Type     | Used by                                    |
| ---------------------------- | -------- | ------------------------------------------ |
| `OCI_REGISTRY`               | Variable | Container build + Helm test workflows      |
| `CI_BOT_APP_ID`              | Variable | Deploy + Helm docs workflows               |
| `REVIEW_APPS_URL`            | Variable | `deploy.yml` (review environment URL base) |
| `UAT_URL` / `PRODUCTION_URL` | Variable | `deploy.yml`, `release.yml`                |
| `CI_BOT_APP_PRIVATE_KEY`     | Secret   | Deploy, release, Helm docs                 |
| Registry credentials         | Secret   | Only when pushing outside GHCR             |

Document runtime versions (`.tool-versions`, `.nvmrc`, `.python-version`, etc.) and include them in Dependabot so upgrades arrive as PRs.

## Pinning Strategy

Always pin workflows and actions by commit SHA:

```yaml
uses: hoverkraft-tech/ci-github-container/.github/workflows/docker-build-images.yml@4f29319e02dd65152386c436e8c3136f380a0e71 # 0.28.0
```

Avoid `@main` or branch names in production pipelines. When Dependabot proposes an update, test the new commit in a branch before merging.

## Staying Up to Date

- Enable Dependabot for `github-actions`, `docker`, and every language ecosystem you ship.
- Review release notes for pinned workflows before bumping their SHAs.
- Note version bumps in PR descriptions so reviewers can audit changes quickly.

## Local Command Reference

```bash
# Scaffold local tooling (builds containers, installs dependencies)
make prepare

# Run static analysis
make lint

# Build application artifacts
make build

# Execute the same bundle CI runs
make ci

# Open a shell inside the application container
make shell
```

Swap `make` for any task runner (`just`, `task`, `npm scripts`) as long as the commands use the same Docker targets consumed by CI.

## Quick Checks Before Pushing

```bash
ls -la .github/workflows/           # Verify workflows exist
yamllint .github/workflows/*.yml    # Validate YAML syntax
# act --list                        # Optional: list workflows if you use act
```

## Need More Help?

- Revisit the [tutorial introduction](./01-getting-started.md)
- Consult [Troubleshooting](./08-troubleshooting.md)
- Join the [Hoverkraft discussions](https://github.com/orgs/hoverkraft-tech/discussions)
- Read the documentation for each reusable workflow linked above

---

üéâ **Congratulations!** Keep this reference handy whenever you modify workflows or onboard a new service.
